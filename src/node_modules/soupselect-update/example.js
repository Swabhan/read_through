'use strict';

var select = require('./lib/soupselect').select,
    htmlparser = require("htmlparser"),
    http = require('http'),
    util = require('util');

// fetch some HTML...
var options = {
    hostname: 'pastebin.com',
    path: '/CxnNjWAy',
    port: 80
};

var req = http.request(options, (res) => {
    res.setEncoding('utf8');

    var body = "";
    res.on('data', function (chunk) {
        body = body + chunk;
    });

    res.on('end', function() {
        // now we have the whole body, parse it and select the nodes we want...
        var handler = new htmlparser.DefaultHandler(function(err, dom) {
            if (err) {
                util.debug("Error: " + err);
            } else {

                // soupselect happening here...
                var titles = select(dom, '#paste_code');

                console.log("Top stories from reddit");
                titles.forEach(function(title) {
                    console.log("- " + title.children[0].raw + " [" + title.attribs.href + "]\n");
                })
            }
        });

        var parser = new htmlparser.Parser(handler);
        parser.parseComplete(body);
    });
});

req.on('error', (e) => {
    console.log('error: ' + e);
});

req.end();
